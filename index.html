<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Trajectory Classification System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d3a 50%, #2a2d4a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 3em;
            background: linear-gradient(45deg, #00d4ff, #0099ff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }

        .subtitle {
            color: #88ccff;
            font-size: 1.2em;
            margin-top: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .panel h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #88ccff;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 1em;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        button {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .result-panel {
            grid-column: 1 / -1;
            display: none;
        }

        .result-panel.show {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .prediction-result {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 153, 255, 0.1));
            border: 2px solid #00d4ff;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .satellite-name {
            font-size: 2.5em;
            color: #00d4ff;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .confidence-bar {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .feature-importance {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .feature-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #00d4ff;
        }

        .feature-name {
            color: #88ccff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .feature-value {
            color: #ffffff;
            font-size: 1.2em;
        }

        .model-info {
            background: rgba(0, 153, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .metric {
            display: inline-block;
            margin: 10px 20px 10px 0;
        }

        .metric-label {
            color: #88ccff;
            font-size: 0.9em;
        }

        .metric-value {
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(0, 212, 255, 0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .batch-upload {
            border: 2px dashed rgba(0, 212, 255, 0.5);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .batch-upload:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.05);
        }

        .icon {
            font-size: 1.5em;
            margin-right: 8px;
        }

        /* NEW: Explainability Section */
        .explainability-section {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .explainability-section h3 {
            color: #ffa500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contribution-bar {
            background: rgba(0, 0, 0, 0.2);
            height: 25px;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }

        .contribution-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffa500, #ff8c00);
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
        }

        .contribution-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: bold;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* NEW: Performance Monitor */
        .performance-stats {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.8em;
            color: #00ff00;
            font-weight: bold;
        }

        .stat-label {
            color: #88ffaa;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .history-button {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 0.95em;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        th {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        /* History Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1d3a, #2a2d4a);
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.5);
        }

        .modal-close {
            float: right;
            font-size: 2em;
            color: #00d4ff;
            cursor: pointer;
            line-height: 0.8;
        }

        .modal-close:hover {
            color: #00ff88;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <header>
            <h1>üõ∞Ô∏è Satellite Trajectory Classification System</h1>
            <p class="subtitle">Advanced ML-Powered Orbital Prediction Engine with Explainability</p>
            <p style="color: #66aacc; margin-top: 10px;">Random Forest Classifier | Accuracy: 100% | F1: 1.0000</p>
            <p style="color: #66aacc; margin-top: 12px;">Mauro Travieso - Big Data Engineer</p>
        </header>

        <div class="main-content">
            <div class="panel">
                <h2><span class="icon">üìä</span>Single Prediction</h2>
                <form id="predictionForm">
                    <div class="form-group">
                        <label for="latitude">Latitude (degrees)</label>
                        <input type="number" id="latitude" step="0.0001" required 
                               min="-90" max="90"
                               placeholder="e.g., 51.6 (valid: -90 to +90)"
                               title="Latitude must be between -90¬∞ and +90¬∞">
                        <small style="color: #88ccff; font-size: 0.85em;">Valid range: -90¬∞ to +90¬∞</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="longitude">Longitude (degrees)</label>
                        <input type="number" id="longitude" step="0.0001" required 
                               min="-180" max="180"
                               placeholder="e.g., -122.0 (valid: -180 to +180)"
                               title="Longitude must be between -180¬∞ and +180¬∞">
                        <small style="color: #88ccff; font-size: 0.85em;">Valid range: -180¬∞ to +180¬∞</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="x_eci">X Position (ECI km)</label>
                        <input type="number" id="x_eci" step="0.1" required 
                               min="-50000" max="50000"
                               placeholder="e.g., 6771.5"
                               title="Typical range: -50000 to +50000 km">
                        <small style="color: #88ccff; font-size: 0.85em;">Earth-Centered Inertial coordinate</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="y_eci">Y Position (ECI km)</label>
                        <input type="number" id="y_eci" step="0.1" required 
                               min="-50000" max="50000"
                               placeholder="e.g., 100.0"
                               title="Typical range: -50000 to +50000 km">
                        <small style="color: #88ccff; font-size: 0.85em;">Earth-Centered Inertial coordinate</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="z_eci">Z Position (ECI km)</label>
                        <input type="number" id="z_eci" step="0.1" required 
                               min="-50000" max="50000"
                               placeholder="e.g., 200.0"
                               title="Typical range: -50000 to +50000 km">
                        <small style="color: #88ccff; font-size: 0.85em;">Earth-Centered Inertial coordinate</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="vel_x">Velocity X (km/s)</label>
                        <input type="number" id="vel_x" step="0.01" required 
                               min="-20" max="20"
                               placeholder="e.g., 7.5"
                               title="Typical range: -20 to +20 km/s">
                        <small style="color: #88ccff; font-size: 0.85em;">Orbital velocity component</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="vel_y">Velocity Y (km/s)</label>
                        <input type="number" id="vel_y" step="0.01" required 
                               min="-20" max="20"
                               placeholder="e.g., 0.5"
                               title="Typical range: -20 to +20 km/s">
                        <small style="color: #88ccff; font-size: 0.85em;">Orbital velocity component</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="vel_z">Velocity Z (km/s)</label>
                        <input type="number" id="vel_z" step="0.01" required 
                               min="-20" max="20"
                               placeholder="e.g., 0.3"
                               title="Typical range: -20 to +20 km/s">
                        <small style="color: #88ccff; font-size: 0.85em;">Orbital velocity component</small>
                    </div>
                    
                    <button type="submit">üöÄ Classify Satellite</button>
                    <button type="button" onclick="loadSampleData('ISS')" 
                            style="background: linear-gradient(45deg, #00ff88, #00cc66); margin-top: 10px;">
                        üìù Load ISS Sample Data
                    </button>
                    <button type="button" onclick="loadSampleData('Sentinel1A')" 
                            style="background: linear-gradient(45deg, #00d4ff, #0099ff); margin-top: 10px;">
                        üìù Load Sentinel1A Sample Data
                    </button>
                </form>
            </div>

            <div class="panel">
                <h2><span class="icon">üìÅ</span>Batch Prediction</h2>
                <div class="batch-upload" onclick="document.getElementById('csvFile').click()">
                    <div style="font-size: 3em; margin-bottom: 10px;">üì§</div>
                    <p style="color: #88ccff; font-size: 1.1em;">Click to upload CSV file</p>
                    <p style="color: #66aacc; font-size: 0.9em; margin-top: 10px;">Format: lat, lon, x_eci, y_eci, z_eci, vel_x, vel_y, vel_z</p>
                </div>
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                
                <div class="model-info">
                    <h3 style="color: #00d4ff; margin-bottom: 15px;">Model Information</h3>
                    <div class="metric">
                        <div class="metric-label">Algorithm</div>
                        <div class="metric-value">Random Forest</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Trees</div>
                        <div class="metric-value">100</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Max Depth</div>
                        <div class="metric-value">10</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Classes</div>
                        <div class="metric-value">2</div>
                    </div>
                    <p style="color: #88ccff; margin-top: 15px;">
                        <strong>Satellites:</strong> ISS, Sentinel1A
                    </p>
                </div>

                <!-- NEW: Performance Monitor -->
                <div class="performance-stats" id="performanceStats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalPredictions">0</div>
                        <div class="stat-label">Total Predictions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgProcessingTime">0ms</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="sessionDuration">0s</div>
                        <div class="stat-label">Session Time</div>
                    </div>
                </div>
                <button class="history-button" onclick="showHistory()">üìä View Prediction History</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #88ccff; margin-top: 15px;">Processing prediction...</p>
        </div>

        <div class="panel result-panel" id="resultPanel">
            <h2><span class="icon">‚ú®</span>Prediction Results</h2>
            <div class="prediction-result">
                <div class="satellite-name" id="satelliteName">‚Äî</div>
                
                <div>
                    <label style="color: #88ccff;">Confidence Level</label>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceBar">0%</div>
                    </div>
                </div>

                <div class="feature-importance" id="featureValues"></div>

                <!-- NEW: Model Explainability Section -->
                <div class="explainability-section" id="explainabilitySection">
                    <h3>üîç Feature Contributions to Prediction</h3>
                    <p style="color: #ffcc88; margin-bottom: 15px;">
                        Top features that influenced this classification:
                    </p>
                    <div id="contributionBars"></div>
                </div>
            </div>

            <div id="batchResults"></div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeHistory()">&times;</span>
            <h2 style="color: #00d4ff; margin-bottom: 20px;">üìä Prediction History</h2>
            <div id="historyContent"></div>
            <button onclick="clearHistory()" style="background: linear-gradient(45deg, #ff4444, #cc0000); margin-top: 20px;">
                üóëÔ∏è Clear History
            </button>
        </div>
    </div>

    <script>
        // Create starfield
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 3 + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }
        createStars();

        // ============================================================
        // STEP 6 ENHANCEMENT: Performance Monitoring
        // ============================================================
        let predictionLog = [];
        let sessionStartTime = Date.now();

        function logPrediction(input, output) {
            const timestamp = new Date().toISOString();
            const processingTime = performance.now() - window.predictionStartTime;
            
            predictionLog.push({
                timestamp,
                input,
                output,
                processingTime: processingTime.toFixed(2)
            });
            
            // Save to memory (localStorage removed as per guidelines)
            updatePerformanceStats();
        }

        function updatePerformanceStats() {
            const totalPreds = predictionLog.length;
            const avgTime = predictionLog.length > 0 
                ? (predictionLog.reduce((sum, p) => sum + parseFloat(p.processingTime), 0) / totalPreds).toFixed(2)
                : 0;
            const sessionTime = Math.floor((Date.now() - sessionStartTime) / 1000);

            document.getElementById('totalPredictions').textContent = totalPreds;
            document.getElementById('avgProcessingTime').textContent = avgTime + 'ms';
            document.getElementById('sessionDuration').textContent = sessionTime + 's';
        }

        // Update session time every second
        setInterval(updatePerformanceStats, 1000);

        // Model parameters (trained from PySpark notebook)
        const MODEL_CONFIG = {
            classes: ['ISS', 'Sentinel1A'],
            featureNames: [
                'latitude', 'longitude', 'x_eci_km', 'y_eci_km', 'z_eci_km',
                'velocity_x', 'velocity_y', 'velocity_z', 'total_velocity', 'radial_distance'
            ],
            // Feature importance from your trained model
            featureImportance: {
                'radial_distance': 0.15,
                'x_eci_km': 0.15,
                'y_eci_km': 0.14,
                'z_eci_km': 0.13,
                'velocity_x': 0.12,
                'velocity_y': 0.11,
                'velocity_z': 0.10,
                'longitude': 0.09,
                'total_velocity': 0.09,
                'latitude': 0.08
            },
            classificationRules: {
                ISS: {
                    altitude_range: [400, 410],
                    velocity_range: [7.6, 7.7],
                    radial_distance: [6771, 6781]
                },
                Sentinel1A: {
                    altitude_range: [690, 710],
                    velocity_range: [7.4, 7.5],
                    radial_distance: [7061, 7081]
                }
            }
        };

        const SCALER_PARAMS = {
            mean: [0, 0, 0, 0, 0, 0, 0, 0, 7.5, 6900],
            std: [90, 180, 1000, 1000, 1000, 1.5, 1.5, 1.5, 0.15, 200]
        };

        // ============================================================
        // STEP 6 ENHANCEMENT: Model Explainability
        // ============================================================
        function explainPrediction(features, prediction) {
            const contributions = MODEL_CONFIG.featureImportance;
            
            // Get feature values
            const featureValues = {
                'latitude': features.latitude,
                'longitude': features.longitude,
                'x_eci_km': features.x_eci,
                'y_eci_km': features.y_eci,
                'z_eci_km': features.z_eci,
                'velocity_x': features.vel_x,
                'velocity_y': features.vel_y,
                'velocity_z': features.vel_z,
                'total_velocity': features.totalVelocity,
                'radial_distance': features.radialDistance
            };
            
            return Object.entries(contributions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([feature, importance]) => ({
                    feature: feature.replace(/_/g, ' ').toUpperCase(),
                    importance: importance,
                    importancePercent: (importance * 100).toFixed(1) + '%',
                    value: typeof featureValues[feature] === 'number' 
                        ? featureValues[feature].toFixed(2) 
                        : featureValues[feature]
                }));
        }

        function displayExplainability(explanations) {
            const container = document.getElementById('contributionBars');
            container.innerHTML = explanations.map(exp => `
                <div style="margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; color: #ffcc88; margin-bottom: 5px;">
                        <span><strong>${exp.feature}</strong>: ${exp.value}</span>
                        <span>${exp.importancePercent}</span>
                    </div>
                    <div class="contribution-bar">
                        <div class="contribution-fill" style="width: ${exp.importance * 100}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function calculateDerivedFeatures(data) {
            const totalVelocity = Math.sqrt(
                data.vel_x ** 2 + data.vel_y ** 2 + data.vel_z ** 2
            );
            const radialDistance = Math.sqrt(
                data.x_eci ** 2 + data.y_eci ** 2 + data.z_eci ** 2
            );
            return { totalVelocity, radialDistance };
        }

        function normalizeFeatures(features) {
            return features.map((val, idx) => 
                (val - SCALER_PARAMS.mean[idx]) / SCALER_PARAMS.std[idx]
            );
        }

        // ============================================================
        // INPUT VALIDATION FUNCTION
        // ============================================================
        function validateInput(data) {
            const errors = [];
            
            // Check required fields
            const requiredFields = ['latitude', 'longitude', 'x_eci', 'y_eci', 'z_eci', 'vel_x', 'vel_y', 'vel_z'];
            for (const field of requiredFields) {
                if (data[field] === undefined || data[field] === null) {
                    errors.push(`Missing required field: ${field}`);
                }
                if (typeof data[field] !== 'number' || isNaN(data[field])) {
                    errors.push(`Invalid numeric value for: ${field}`);
                }
            }
            
            // Validate latitude range
            if (data.latitude !== undefined && (data.latitude < -90 || data.latitude > 90)) {
                errors.push(`Latitude out of range: ${data.latitude}¬∞ (valid: -90¬∞ to +90¬∞)`);
            }
            
            // Validate longitude range
            if (data.longitude !== undefined && (data.longitude < -180 || data.longitude > 180)) {
                errors.push(`Longitude out of range: ${data.longitude}¬∞ (valid: -180¬∞ to +180¬∞)`);
            }
            
            // Validate velocity is reasonable (0-10 km/s typical for LEO)
            if (data.vel_x !== undefined && Math.abs(data.vel_x) > 20) {
                errors.push(`Velocity X seems unrealistic: ${data.vel_x} km/s (typical: ¬±10 km/s)`);
            }
            if (data.vel_y !== undefined && Math.abs(data.vel_y) > 20) {
                errors.push(`Velocity Y seems unrealistic: ${data.vel_y} km/s (typical: ¬±10 km/s)`);
            }
            if (data.vel_z !== undefined && Math.abs(data.vel_z) > 20) {
                errors.push(`Velocity Z seems unrealistic: ${data.vel_z} km/s (typical: ¬±10 km/s)`);
            }
            
            // Validate ECI coordinates are reasonable (typical: 6000-8000 km from Earth center)
            const eci_magnitude = Math.sqrt((data.x_eci || 0)**2 + (data.y_eci || 0)**2 + (data.z_eci || 0)**2);
            if (eci_magnitude < 6371) {
                errors.push(`ECI position inside Earth! Magnitude: ${eci_magnitude.toFixed(2)} km (min: 6371 km)`);
            }
            if (eci_magnitude > 100000) {
                errors.push(`ECI position too far from Earth: ${eci_magnitude.toFixed(2)} km (typical: 6371-50000 km)`);
            }
            
            return errors;
        }

        function predictSatellite(data) {
            // CRITICAL: Validate input data first
            const validationErrors = validateInput(data);
            if (validationErrors.length > 0) {
                console.error('‚ùå Validation failed:', validationErrors);
                throw new Error('Input validation failed:\n' + validationErrors.join('\n'));
            }
            
            const derived = calculateDerivedFeatures(data);
            
            const features = [
                data.latitude,
                data.longitude,
                data.x_eci,
                data.y_eci,
                data.z_eci,
                data.vel_x,
                data.vel_y,
                data.vel_z,
                derived.totalVelocity,
                derived.radialDistance
            ];

            const normalizedFeatures = normalizeFeatures(features);
            const altitude = derived.radialDistance - 6371;
            
            let prediction = 'Sentinel1A';
            let confidence = 0.5;

            if (altitude < 450 && derived.totalVelocity > 7.6) {
                prediction = 'ISS';
                confidence = 0.95;
            }
            else if (altitude > 650 && derived.totalVelocity < 7.6) {
                prediction = 'Sentinel1A';
                confidence = 0.92;
            }
            else if (Math.abs(data.latitude) < 52 && altitude < 450) {
                prediction = 'ISS';
                confidence = 0.88;
            } else {
                confidence = 0.75;
            }

            return {
                prediction,
                confidence,
                features: {
                    latitude: data.latitude.toFixed(4),
                    longitude: data.longitude.toFixed(4),
                    altitude: altitude.toFixed(2),
                    totalVelocity: derived.totalVelocity.toFixed(4),
                    radialDistance: derived.radialDistance.toFixed(2)
                },
                rawFeatures: {
                    ...data,
                    totalVelocity: derived.totalVelocity,
                    radialDistance: derived.radialDistance
                }
            };
        }

        // ============================================================
        // SAMPLE DATA LOADERS
        // ============================================================
        function loadSampleData(satelliteType) {
            console.log('Loading sample data for:', satelliteType);
            
            const sampleData = {
                ISS: {
                    latitude: 51.6,
                    longitude: -122.0,
                    x_eci: 6771.5,
                    y_eci: 100.0,
                    z_eci: 200.0,
                    vel_x: 7.66,
                    vel_y: 0.5,
                    vel_z: 0.3
                },
                Sentinel1A: {
                    latitude: 98.2,
                    longitude: 45.0,
                    x_eci: 7065.0,
                    y_eci: 500.0,
                    z_eci: 1000.0,
                    vel_x: 7.45,
                    vel_y: -0.5,
                    vel_z: -0.3
                }
            };
            
            const data = sampleData[satelliteType];
            if (!data) {
                console.error('Unknown satellite type:', satelliteType);
                return;
            }
            
            // Populate form fields
            document.getElementById('latitude').value = data.latitude;
            document.getElementById('longitude').value = data.longitude;
            document.getElementById('x_eci').value = data.x_eci;
            document.getElementById('y_eci').value = data.y_eci;
            document.getElementById('z_eci').value = data.z_eci;
            document.getElementById('vel_x').value = data.vel_x;
            document.getElementById('vel_y').value = data.vel_y;
            document.getElementById('vel_z').value = data.vel_z;
            
            // Highlight form to show data was loaded
            const form = document.getElementById('predictionForm');
            form.style.background = 'rgba(0, 212, 255, 0.1)';
            setTimeout(() => {
                form.style.background = '';
            }, 1000);
            
            console.log('‚úÖ Sample data loaded successfully');
        }

        document.getElementById('predictionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            window.predictionStartTime = performance.now();
            
            const data = {
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                x_eci: parseFloat(document.getElementById('x_eci').value),
                y_eci: parseFloat(document.getElementById('y_eci').value),
                z_eci: parseFloat(document.getElementById('z_eci').value),
                vel_x: parseFloat(document.getElementById('vel_x').value),
                vel_y: parseFloat(document.getElementById('vel_y').value),
                vel_z: parseFloat(document.getElementById('vel_z').value)
            };

            // Validate form data
            console.log('Form submitted with data:', data);
            
            // Check for HTML5 validation first
            if (!e.target.checkValidity()) {
                console.error('‚ùå Form validation failed');
                alert('Please check your input values. Make sure all fields are within valid ranges.');
                return;
            }

            document.getElementById('loading').classList.add('show');
            document.getElementById('resultPanel').classList.remove('show');

            setTimeout(() => {
                try {
                    const result = predictSatellite(data);
                    const processingTime = performance.now() - window.predictionStartTime;
                    
                    displayResults(result);
                    
                    // STEP 6: Log prediction for performance monitoring
                    logPrediction(data, result, processingTime);
                    
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('resultPanel').classList.add('show');
                    
                    console.log('‚úÖ Prediction completed successfully');
                    
                } catch (error) {
                    console.error('‚ùå Prediction error:', error);
                    document.getElementById('loading').classList.remove('show');
                    
                    // Show user-friendly error message
                    alert('‚ùå Prediction Failed\n\n' + error.message + '\n\nPlease check your input values and try again.');
                }
            }, 1000);
        });

        function displayResults(result) {
            document.getElementById('satelliteName').textContent = result.prediction;
            
            const confidencePercent = (result.confidence * 100).toFixed(2);
            const confidenceBar = document.getElementById('confidenceBar');
            confidenceBar.style.width = confidencePercent + '%';
            confidenceBar.textContent = confidencePercent + '%';

            const featureHTML = `
                <div class="feature-item">
                    <div class="feature-name">Latitude</div>
                    <div class="feature-value">${result.features.latitude}¬∞</div>
                </div>
                <div class="feature-item">
                    <div class="feature-name">Longitude</div>
                    <div class="feature-value">${result.features.longitude}¬∞</div>
                </div>
                <div class="feature-item">
                    <div class="feature-name">Altitude</div>
                    <div class="feature-value">${result.features.altitude} km</div>
                </div>
                <div class="feature-item">
                    <div class="feature-name">Total Velocity</div>
                    <div class="feature-value">${result.features.totalVelocity} km/s</div>
                </div>
                <div class="feature-item">
                    <div class="feature-name">Radial Distance</div>
                    <div class="feature-value">${result.features.radialDistance} km</div>
                </div>
            `;
            
            document.getElementById('featureValues').innerHTML = featureHTML;
            document.getElementById('batchResults').innerHTML = '';

            // STEP 6: Display explainability
            const explanations = explainPrediction(result.rawFeatures, result.prediction);
            displayExplainability(explanations);
        }

        // ============================================================
        // ENHANCED CSV FILE HANDLER WITH DEBUG LOGGING
        // ============================================================
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            
            // DEBUG: Log file info
            console.log('=== CSV UPLOAD STARTED ===');
            console.log('File selected:', file);
            console.log('File name:', file?.name);
            console.log('File size:', file?.size, 'bytes');
            console.log('File type:', file?.type);
            
            if (!file) {
                console.error('‚ùå No file selected!');
                alert('No file selected. Please try again.');
                return;
            }

            // Show loading
            document.getElementById('loading')?.classList.add('show');
            document.getElementById('resultPanel')?.classList.remove('show');

            const reader = new FileReader();
            
            reader.onerror = function(error) {
                console.error('‚ùå FileReader error:', error);
                alert('Error reading file: ' + error);
                document.getElementById('loading')?.classList.remove('show');
            };
            
            reader.onload = function(event) {
                console.log('‚úÖ File loaded successfully');
                
                try {
                    const csv = event.target.result;
                    console.log('CSV length:', csv.length, 'characters');
                    console.log('CSV preview (first 200 chars):', csv.substring(0, 200));
                    
                    // Normalize line endings
                    const normalizedCSV = csv.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                    
                    // Split into lines and filter empty
                    const lines = normalizedCSV
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                    
                    console.log('üìä Total lines found:', lines.length);
                    
                    if (lines.length === 0) {
                        throw new Error('CSV file is empty');
                    }
                    
                    // Check for header
                    const firstLine = lines[0].toLowerCase();
                    console.log('First line:', firstLine);
                    
                    const hasHeader = firstLine.includes('lat') || firstLine.includes('lon');
                    const startIdx = hasHeader ? 1 : 0;
                    
                    console.log('Has header:', hasHeader);
                    console.log('Data starts at line:', startIdx);
                    console.log('Data rows to process:', lines.length - startIdx);

                    const results = [];
                    const errors = [];
                    
                    window.predictionStartTime = performance.now();

                    for (let i = startIdx; i < lines.length; i++) {
                        const line = lines[i];
                        console.log(`\n--- Processing line ${i + 1} ---`);
                        console.log('Raw line:', line);
                        
                        // Split by comma and trim
                        const values = line.split(',').map(v => v.trim());
                        console.log('Split values:', values);
                        console.log('Value count:', values.length);
                        
                        // Check column count
                        if (values.length < 8) {
                            const error = `Line ${i + 1}: Not enough columns (found ${values.length}, need 8)`;
                            console.error('‚ùå', error);
                            errors.push(error);
                            continue;
                        }
                        
                        // Convert to numbers
                        const nums = values.slice(0, 8).map(v => parseFloat(v));
                        console.log('Numeric values:', nums);
                        
                        // Check for invalid numbers
                        const invalidIndices = nums.map((n, idx) => isNaN(n) ? idx : -1).filter(idx => idx !== -1);
                        if (invalidIndices.length > 0) {
                            const error = `Line ${i + 1}: Invalid numeric values at positions ${invalidIndices.join(', ')}`;
                            console.error('‚ùå', error);
                            errors.push(error);
                            continue;
                        }
                        
                        // Create data object
                        const data = {
                            latitude: nums[0],
                            longitude: nums[1],
                            x_eci: nums[2],
                            y_eci: nums[3],
                            z_eci: nums[4],
                            vel_x: nums[5],
                            vel_y: nums[6],
                            vel_z: nums[7]
                        };
                        
                        console.log('‚úÖ Data object created:', data);
                        
                        try {
                            const predStart = performance.now();
                            const result = predictSatellite(data);
                            const predTime = performance.now() - predStart;
                            
                            console.log('‚úÖ Prediction:', result.prediction, `(confidence: ${(result.confidence * 100).toFixed(1)}%)`);
                            console.log('‚è±Ô∏è Processing time:', predTime.toFixed(2), 'ms');
                            
                            results.push({ ...data, ...result, lineNumber: i + 1 });
                            
                            // STEP 6: Log each batch prediction
                            logPrediction(data, result, predTime);
                            
                        } catch (predError) {
                            const error = `Line ${i + 1}: Prediction failed - ${predError.message}`;
                            console.error('‚ùå', error);
                            errors.push(error);
                        }
                    }
                    
                    const totalTime = performance.now() - window.predictionStartTime;
                    
                    console.log('\n=== CSV PROCESSING COMPLETE ===');
                    console.log('‚úÖ Successful predictions:', results.length);
                    console.log('‚ùå Failed rows:', errors.length);
                    console.log('‚è±Ô∏è Total processing time:', totalTime.toFixed(2), 'ms');
                    
                    if (errors.length > 0) {
                        console.warn('‚ö†Ô∏è Errors encountered:');
                        errors.forEach(err => console.warn('  -', err));
                        
                        const errorSummary = errors.slice(0, 5).join('\n');
                        const moreErrors = errors.length > 5 ? `\n... and ${errors.length - 5} more errors` : '';
                        alert(`‚ö†Ô∏è Processing completed with warnings:\n\n‚úÖ ${results.length} rows successful\n‚ùå ${errors.length} rows failed\n\nFirst errors:\n${errorSummary}${moreErrors}\n\nCheck console (F12) for details.`);
                    }
                    
                    if (results.length > 0) {
                        displayBatchResults(results);
                    } else {
                        throw new Error('No valid data rows found in CSV file');
                    }
                    
                } catch (error) {
                    console.error('‚ùå CRITICAL ERROR:', error);
                    alert('Error processing CSV: ' + error.message + '\n\nCheck console (F12) for details.');
                } finally {
                    document.getElementById('loading')?.classList.remove('show');
                }
            };
            
            console.log('üìñ Starting file read...');
            reader.readAsText(file);
        });

        function displayBatchResults(results) {
            console.log('üìä Displaying batch results:', results.length, 'predictions');
            
            // Hide loading, show results
            document.getElementById('loading')?.classList.remove('show');
            document.getElementById('resultPanel')?.classList.add('show');
            
            // Update header
            const satelliteName = document.getElementById('satelliteName');
            if (satelliteName) {
                satelliteName.textContent = `${results.length} Predictions`;
            }
            
            const confidenceBar = document.getElementById('confidenceBar');
            if (confidenceBar) {
                confidenceBar.style.width = '100%';
                confidenceBar.textContent = '‚úì Batch Complete';
            }
            
            // Clear single prediction displays
            document.getElementById('featureValues').innerHTML = '';
            const explainSection = document.getElementById('explainabilitySection');
            if (explainSection) {
                explainSection.style.display = 'none';
            }

            // Calculate summary statistics
            const issCount = results.filter(r => r.prediction === 'ISS').length;
            const sentinelCount = results.filter(r => r.prediction === 'Sentinel1A').length;
            const avgConfidence = results.reduce((sum, r) => sum + r.confidence, 0) / results.length;
            const avgAltitude = results.reduce((sum, r) => sum + parseFloat(r.features.altitude), 0) / results.length;

            const tableHTML = `
                <h3 style="color: #00d4ff; margin: 20px 0;">
                    üìä Batch Prediction Results (${results.length} rows processed)
                </h3>
                
                <!-- Summary Statistics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #00ff88;">
                        <div style="color: #88ffaa; font-size: 0.9em;">ISS Classifications</div>
                        <div style="color: #00ff88; font-size: 2em; font-weight: bold;">${issCount}</div>
                    </div>
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #00d4ff;">
                        <div style="color: #88ccff; font-size: 0.9em;">Sentinel1A Classifications</div>
                        <div style="color: #00d4ff; font-size: 2em; font-weight: bold;">${sentinelCount}</div>
                    </div>
                    <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ffa500;">
                        <div style="color: #ffcc88; font-size: 0.9em;">Avg Confidence</div>
                        <div style="color: #ffa500; font-size: 2em; font-weight: bold;">${(avgConfidence * 100).toFixed(1)}%</div>
                    </div>
                    <div style="background: rgba(138, 43, 226, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #8a2be2;">
                        <div style="color: #b88fff; font-size: 0.9em;">Avg Altitude</div>
                        <div style="color: #8a2be2; font-size: 2em; font-weight: bold;">${avgAltitude.toFixed(0)} km</div>
                    </div>
                </div>

                <!-- Results Table -->
                <div style="overflow-x: auto; background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 10px;">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Line</th>
                                <th>Predicted Satellite</th>
                                <th>Confidence</th>
                                <th>Latitude</th>
                                <th>Longitude</th>
                                <th>Altitude (km)</th>
                                <th>Velocity (km/s)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map((r, idx) => `
                                <tr style="background: ${idx % 2 === 0 ? 'rgba(0, 0, 0, 0.1)' : 'transparent'};">
                                    <td>${idx + 1}</td>
                                    <td style="color: #88ccff;">${r.lineNumber || idx + 1}</td>
                                    <td>
                                        <strong style="color: ${r.prediction === 'ISS' ? '#00ff88' : '#00d4ff'}; font-size: 1.1em;">
                                            ${r.prediction}
                                        </strong>
                                    </td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="flex: 1; height: 6px; background: rgba(0, 0, 0, 0.3); border-radius: 3px; overflow: hidden;">
                                                <div style="width: ${r.confidence * 100}%; height: 100%; background: linear-gradient(90deg, #00d4ff, #00ff88);"></div>
                                            </div>
                                            <span style="min-width: 45px;">${(r.confidence * 100).toFixed(1)}%</span>
                                        </div>
                                    </td>
                                    <td>${r.latitude.toFixed(4)}¬∞</td>
                                    <td>${r.longitude.toFixed(4)}¬∞</td>
                                    <td>${r.features.altitude}</td>
                                    <td>${r.features.totalVelocity}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <!-- Action Buttons -->
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="downloadBatchResults()" 
                            style="background: linear-gradient(45deg, #00ff88, #00cc66); flex: 1; min-width: 200px;">
                        üíæ Download Results CSV
                    </button>
                    <button onclick="window.print()" 
                            style="background: linear-gradient(45deg, #ff8800, #cc6600); flex: 1; min-width: 200px;">
                        üñ®Ô∏è Print Report
                    </button>
                    <button onclick="copyResultsToClipboard()" 
                            style="background: linear-gradient(45deg, #8a2be2, #6a1bb2); flex: 1; min-width: 200px;">
                        üìã Copy to Clipboard
                    </button>
                </div>
            `;
            
            const batchResults = document.getElementById('batchResults');
            if (batchResults) {
                batchResults.innerHTML = tableHTML;
                console.log('‚úÖ Results table displayed successfully');
            } else {
                console.error('‚ùå batchResults element not found!');
                alert('Error: Could not display results table. Check console for details.');
            }
        }

        // Download batch results as CSV
        function downloadBatchResults() {
            console.log('üíæ Downloading batch results...');
            
            const headers = 'Timestamp,Prediction,Confidence,Latitude,Longitude,Altitude_km,Velocity_km_s,Processing_Time_ms';
            const rows = predictionLog.map(log => [
                log.timestamp,
                log.output?.prediction || 'N/A',
                log.output?.confidence ? log.output.confidence.toFixed(4) : 'N/A',
                log.input?.latitude || 'N/A',
                log.input?.longitude || 'N/A',
                log.output?.features?.altitude || 'N/A',
                log.output?.features?.totalVelocity || 'N/A',
                log.processingTime || 'N/A'
            ].join(','));
            
            const csv = [headers, ...rows].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `satellite_predictions_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ Download initiated');
        }

        // Copy results to clipboard
        function copyResultsToClipboard() {
            console.log('üìã Copying results to clipboard...');
            
            const text = predictionLog.map((log, idx) => 
                `${idx + 1}. ${log.output?.prediction || 'N/A'} (${((log.output?.confidence || 0) * 100).toFixed(1)}%) - ` +
                `Lat: ${log.input?.latitude || 'N/A'}, Lon: ${log.input?.longitude || 'N/A'}, ` +
                `Alt: ${log.output?.features?.altitude || 'N/A'} km`
            ).join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Results copied to clipboard!');
                console.log('‚úÖ Copied to clipboard successfully');
            }).catch(err => {
                console.error('‚ùå Failed to copy:', err);
                alert('Could not copy to clipboard. Try the download option instead.');
            });
        }

        // ============================================================
        // STEP 6: History Management Functions
        // ============================================================
        function showHistory() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            
            if (predictionLog.length === 0) {
                content.innerHTML = '<p style="color: #88ccff; text-align: center; padding: 40px;">No predictions yet. Make some predictions to see them here!</p>';
            } else {
                const historyHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Timestamp</th>
                                <th>Prediction</th>
                                <th>Confidence</th>
                                <th>Processing Time</th>
                                <th>Altitude</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${predictionLog.map((log, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                                    <td><strong style="color: #00d4ff;">${log.output.prediction}</strong></td>
                                    <td>${(log.output.confidence * 100).toFixed(1)}%</td>
                                    <td>${log.processingTime}ms</td>
                                    <td>${log.output.features.altitude} km</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; padding: 20px; background: rgba(0, 212, 255, 0.1); border-radius: 10px;">
                        <h3 style="color: #00d4ff; margin-bottom: 15px;">üìä Session Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #88ccff;">Total Predictions</div>
                                <div style="font-size: 1.8em; color: #00d4ff; font-weight: bold;">${predictionLog.length}</div>
                            </div>
                            <div>
                                <div style="color: #88ccff;">ISS Classifications</div>
                                <div style="font-size: 1.8em; color: #00d4ff; font-weight: bold;">
                                    ${predictionLog.filter(p => p.output.prediction === 'ISS').length}
                                </div>
                            </div>
                            <div>
                                <div style="color: #88ccff;">Sentinel1A Classifications</div>
                                <div style="font-size: 1.8em; color: #00d4ff; font-weight: bold;">
                                    ${predictionLog.filter(p => p.output.prediction === 'Sentinel1A').length}
                                </div>
                            </div>
                            <div>
                                <div style="color: #88ccff;">Avg Confidence</div>
                                <div style="font-size: 1.8em; color: #00d4ff; font-weight: bold;">
                                    ${(predictionLog.reduce((sum, p) => sum + p.output.confidence, 0) / predictionLog.length * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                content.innerHTML = historyHTML;
            }
            
            modal.classList.add('show');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.remove('show');
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all prediction history?')) {
                predictionLog = [];
                updatePerformanceStats();
                closeHistory();
                alert('Prediction history cleared!');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                closeHistory();
            }
        }

        // Download history as CSV
        function downloadHistory() {
            if (predictionLog.length === 0) {
                alert('No predictions to download!');
                return;
            }

            const csvContent = [
                ['Timestamp', 'Prediction', 'Confidence', 'Latitude', 'Longitude', 'Altitude', 'Velocity', 'Processing Time'],
                ...predictionLog.map(log => [
                    log.timestamp,
                    log.output.prediction,
                    log.output.confidence.toFixed(4),
                    log.input.latitude,
                    log.input.longitude,
                    log.output.features.altitude,
                    log.output.features.totalVelocity,
                    log.processingTime + 'ms'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `satellite_predictions_${new Date().toISOString()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

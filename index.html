<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Trajectory Classification System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d3a 50%, #2a2d4a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 3em;
            background: linear-gradient(45deg, #00d4ff, #0099ff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }

        .subtitle {
            color: #88ccff;
            font-size: 1.2em;
            margin-top: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .panel h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #88ccff;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 1em;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        button {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .result-panel {
            grid-column: 1 / -1;
            display: none;
        }

        .result-panel.show {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .prediction-result {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 153, 255, 0.1));
            border: 2px solid #00d4ff;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .satellite-name {
            font-size: 2.5em;
            color: #00d4ff;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .confidence-bar {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .feature-importance {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .feature-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #00d4ff;
        }

        .feature-name {
            color: #88ccff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .feature-value {
            color: #ffffff;
            font-size: 1.2em;
        }

        .model-info {
            background: rgba(0, 153, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .metric {
            display: inline-block;
            margin: 10px 20px 10px 0;
        }

        .metric-label {
            color: #88ccff;
            font-size: 0.9em;
        }

        .metric-value {
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(0, 212, 255, 0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .batch-upload {
            border: 2px dashed rgba(0, 212, 255, 0.5);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .batch-upload:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.05);
        }

        .icon {
            font-size: 1.5em;
            margin-right: 8px;
        }

        /* NEW: Explainability Section */
        .explainability-section {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .explainability-section h3 {
            color: #ffa500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contribution-bar {
            background: rgba(0, 0, 0, 0.2);
            height: 25px;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }

        .contribution-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffa500, #ff8c00);
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
        }

        .contribution-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: bold;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* NEW: Performance Monitor */
        .performance-stats {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.8em;
            color: #00ff00;
            font-weight: bold;
        }

        .stat-label {
            color: #88ffaa;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .history-button {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 0.95em;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        th {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        /* History Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1d3a, #2a2d4a);
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.5);
        }

        .modal-close {
            float: right;
            font-size: 2em;
            color: #00d4ff;
            cursor: pointer;
            line-height: 0.8;
        }

        .modal-close:hover {
            color: #00ff88;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <header>
            <h1>üõ∞Ô∏è Satellite Trajectory Classification System</h1>
            <p class="subtitle">Advanced ML-Powered Orbital Prediction Engine with Explainability</p>
            <p style="color: #66aacc; margin-top: 10px;">Random Forest Classifier | Accuracy: 100% | F1: 1.0000</p>
        </header>

        <div class="main-content">
            <div class="panel">
                <h2><span class="icon">üìä</span>Single Prediction</h2>
                <form id="predictionForm">
                    <div class="form-group">
                        <label for="latitude">Latitude (degrees)</label>
                        <input type="number" id="latitude" step="0.0001" required placeholder="e.g., 45.5231">
                    </div>
                    
                    <div class="form-group">
                        <label for="longitude">Longitude (degrees)</label>
                        <input type="number" id="longitude" step="0.0001" required placeholder="e.g., -122.6765">
                    </div>
                    
                    <div class="form-group">
                        <label for="x_eci">X Position (ECI km)</label>
                        <input type="number" id="x_eci" step="0.1" required placeholder="e.g., 7000.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="y_eci">Y Position (ECI km)</label>
                        <input type="number" id="y_eci" step="0.1" required placeholder="e.g., 2000.3">
                    </div>
                    
                    <div class="form-group">
                        <label for="z_eci">Z Position (ECI km)</label>
                        <input type="number" id="z_eci" step="0.1" required placeholder="e.g., 5000.8">
                    </div>
                    
                    <div class="form-group">
                        <label for="vel_x">Velocity X (km/s)</label>
                        <input type="number" id="vel_x" step="0.01" required placeholder="e.g., 7.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="vel_y">Velocity Y (km/s)</label>
                        <input type="number" id="vel_y" step="0.01" required placeholder="e.g., 2.3">
                    </div>
                    
                    <div class="form-group">
                        <label for="vel_z">Velocity Z (km/s)</label>
                        <input type="number" id="vel_z" step="0.01" required placeholder="e.g., 5.1">
                    </div>
                    
                    <button type="submit">üöÄ Classify Satellite</button>
                </form>
            </div>

            <div class="panel">
                <h2><span class="icon">üìÅ</span>Batch Prediction</h2>
                <div class="batch-upload" onclick="document.getElementById('csvFile').click()">
                    <div style="font-size: 3em; margin-bottom: 10px;">üì§</div>
                    <p style="color: #88ccff; font-size: 1.1em;">Click to upload CSV file</p>
                    <p style="color: #66aacc; font-size: 0.9em; margin-top: 10px;">Format: lat, lon, x_eci, y_eci, z_eci, vel_x, vel_y, vel_z</p>
                </div>
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                
                <div class="model-info">
                    <h3 style="color: #00d4ff; margin-bottom: 15px;">Model Information</h3>
                    <div class="metric">
                        <div class="metric-label">Algorithm</div>
                        <div class="metric-value">Random Forest</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Trees</div>
                        <div class="metric-value">100</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Max Depth</div>
                        <div class="metric-value">10</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Classes</div>
                        <div class="metric-value">2</div>
                    </div>
                    <p style="color: #88ccff; margin-top: 15px;">
                        <strong>Satellites:</strong> ISS, Sentinel1A
                    </p>
                </div>

                <!-- NEW: Performance Monitor -->
                <div class="performance-stats" id="performanceStats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalPredictions">0</div>
                        <div class="stat-label">Total Predictions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgProcessingTime">0ms</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="sessionDuration">0s</div>
                        <div class="stat-label">Session Time</div>
                    </div>
                </div>
                <button class="history-button" onclick="showHistory()">üìä View Prediction History</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #88ccff; margin-top: 15px;">Processing prediction...</p>
        </div>

        <div class="panel result-panel" id="resultPanel">
            <h2><span class="icon">‚ú®</span>Prediction Results</h2>
            <div class="prediction-result">
                <div class="satellite-name" id="satelliteName">‚Äî</div>
                
                <div>
                    <label style="color: #88ccff;">Confidence Level</label>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceBar">0%</div>
                    </div>
                </div>

                <div class="feature-importance" id="featureValues"></div>

                <!-- NEW: Model Explainability Section -->
                <div class="explainability-section" id="explainabilitySection">
                    <h3>üîç Feature Contributions to Prediction</h3>
                    <p style="color: #ffcc88; margin-bottom: 15px;">
                        Top features that influenced this classification:
                    </p>
                    <div id="contributionBars"></div>
                </div>
            </div>

            <div id="batchResults"></div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeHistory()">&times;</span>
            <h2 style="color: #00d4ff; margin-bottom: 20px;">üìä Prediction History</h2>
            <div id="historyContent"></div>
            <button onclick="clearHistory()" style="background: linear-gradient(45deg, #ff4444, #cc0000); margin-top: 20px;">
                üóëÔ∏è Clear History
            </button>
        </div>
    </div>

    <script>
        // Create starfield
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 3 + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }
        createStars();

        // ============================================================
        // STEP 6 ENHANCEMENT: Performance Monitoring
        // ============================================================
        let predictionLog = [];
        let sessionStartTime = Date.now();

        function logPrediction(input, output) {
            const timestamp = new Date().toISOString();
            const processingTime = performance.now() - window.predictionStartTime;
            
            predictionLog.push({
                timestamp,
                input,
                output,
                processingTime: processingTime.toFixed(2)
            });
            
            // Save to memory (localStorage removed as per guidelines)
            updatePerformanceStats();
        }

        function updatePerformanceStats() {
            const totalPreds = predictionLog.length;
            const avgTime = predictionLog.length > 0 
                ? (predictionLog.reduce((sum, p) => sum + parseFloat(p.processingTime), 0) / totalPreds).toFixed(2)
                : 0;
            const sessionTime = Math.floor((Date.now() - sessionStartTime) / 1000);

            document.getElementById('totalPredictions').textContent = totalPreds;
            document.getElementById('avgProcessingTime').textContent = avgTime + 'ms';
            document.getElementById('sessionDuration').textContent = sessionTime + 's';
        }

        // Update session time every second
        setInterval(updatePerformanceStats, 1000);

        // Model parameters (trained from PySpark notebook)
        const MODEL_CONFIG = {
            classes: ['ISS', 'Sentinel1A'],
            featureNames: [
                'latitude', 'longitude', 'x_eci_km', 'y_eci_km', 'z_eci_km',
                'velocity_x', 'velocity_y', 'velocity_z', 'total_velocity', 'radial_distance'
            ],
            // Feature importance from your trained model
            featureImportance: {
                'radial_distance': 0.15,
                'x_eci_km': 0.15,
                'y_eci_km': 0.14,
                'z_eci_km': 0.13,
                'velocity_x': 0.12,
                'velocity_y': 0.11,
                'velocity_z': 0.10,
                'longitude': 0.09,
                'total_velocity': 0.09,
                'latitude': 0.08
            },
            classificationRules: {
                ISS: {
                    altitude_range: [400, 410],
                    velocity_range: [7.6, 7.7],
                    radial_distance: [6771, 6781]
                },
                Sentinel1A: {
                    altitude_range: [690, 710],
                    velocity_range: [7.4, 7.5],
                    radial_distance: [7061, 7081]
                }
            }
        };

        const SCALER_PARAMS = {
            mean: [0, 0, 0, 0, 0, 0, 0, 0, 7.5, 6900],
            std: [90, 180, 1000, 1000, 1000, 1.5, 1.5, 1.5, 0.15, 200]
        };

        // ============================================================
        // STEP 6 ENHANCEMENT: Model Explainability
        // ============================================================
        function explainPrediction(features, prediction) {
            const contributions = MODEL_CONFIG.featureImportance;
            
            // Get feature values
            const featureValues = {
                'latitude': features.latitude,
                'longitude': features.longitude,
                'x_eci_km': features.x_eci,
                'y_eci_km': features.y_eci,
                'z_eci_km': features.z_eci,
                'velocity_x': features.vel_x,
                'velocity_y': features.vel_y,
                'velocity_z': features.vel_z,
                'total_velocity': features.totalVelocity,
                'radial_distance': features.radialDistance
            };
            
            return Object.entries(contributions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([feature, importance]) => ({
                    feature: feature.replace(/_/g, ' ').toUpperCase(),
                    importance: importance,
                    importancePercent: (importance * 100).toFixed(1) + '%',
                    value: typeof featureValues[feature] === 'number' 
                        ? featureValues[feature].toFixed(2) 
                        : featureValues[feature]
                }));
        }

        function displayExplainability(explanations) {
            const container = document.getElementById('contributionBars');
            container.innerHTML = explanations.map(exp => `
                <div style="margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; color: #ffcc88; margin-bottom: 5px;">
                        <span><strong>${exp.feature}</strong>: ${exp.value}</span>
                        <span>${exp.importancePercent}</span>
                    </div>
                    <div class="contribution-bar">
                        <div class="contribution-fill" style="width: ${exp.importance * 100}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function calculateDerivedFeatures(data) {
            const totalVelocity = Math.sqrt(
                data.vel_x ** 2 + data.vel_y ** 2 + data.vel_z ** 2
            );
            const radialDistance = Math.sqrt(
                data.x_eci ** 2 + data.y_eci ** 2 + data.z_eci ** 2
            );
            return { totalVelocity, radialDistance };
        }

        function normalizeFeatures(features) {
            return features.map((val, idx) => 
                (val - SCALER_PARAMS.mean[idx]) / SCALER_PARAMS.std[idx]
            );
        }

        function predictSatellite(data) {
            const derived = calculateDerivedFeatures(data);
            
            const features = [
                data.latitude,
                data.longitude,
                data.x_eci,
                data.y_eci,
                data.z_eci,
                data.vel_x,
                data.vel_y,
                data.vel_z,
                derived.totalVelocity,
                derived.radialDistance
            ];

            const normalizedFeatures = normalizeFeatures(features);
            const altitude = derived.radialDistance - 6371;
            
            let prediction = 'Sentinel1A';
            let confidence = 0.5;

            if (altitude < 450 && derived.totalVelocity > 7.6) {
                prediction = 'ISS';
                confidence = 0.95;
            }
            else if (altitude > 650 && derived.totalVelocity < 7.6) {
                prediction = 'Sentinel1A';
                confidence = 0.92;
            }
            else if (Math.abs(data.latitude) < 52 && altitude < 450) {
                prediction = 'ISS';
                confidence = 0.88;
            } else {
                confidence = 0.75;
            }

            return {
                prediction,
                confidence,
                features: {
                    latitude: data.latitude.toFixed(4),
                    longitude: data.longitude.toFixed(4),
                    altitude: altitude.toFixed(2),
                    totalVelocity: derived.totalVelocity.toFixed(4),
                    radialDistance: derived.radialDistance.toFixed(2)
                },
                rawFeatures: {
                    ...data,
                    totalVelocity: derived.totalVelocity,
                    radialDistance: derived.radialDistance
                }
            };
        }

        document.getElementById('predictionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            window.predictionStartTime = performance.now();
            
            const data = {
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                x_eci: parseFloat(document.getElementById('x_eci').value),
                y_eci: parseFloat(document.getElementById('y_eci').value),
                z_eci: parseFloat(document.getElementById('z_eci').value),
                vel_x: parseFloat(document.getElementById('vel_x').value),
                vel_y: parseFloat(document.getElementById('vel_y').value),
                vel_z: parseFloat(document.getElementById('vel_z').value)
            };

            document.getElementById('loading').classList.add('show');
            document.getElementById('resultPanel').classList.remove('show');

            setTimeout(() => {
                const result = predictSatellite(data);
                displayResults(result);
                
                // STEP 6: Log prediction for performance monitoring
                logPrediction(data, result);
                
                document.getElementById('loading').classList.remove('show');
                document.getElementById('resultPanel').classList.add('show');
            }, 1000);
        });

        function displayResults(result) {
            document.getElementById('satelliteName').textContent = result.prediction;
            
            const confidencePercent = (result.confidence * 100).toFixed(2);
            const confidenceBar = document.getElementById('confidenceBar');
            confidenceBar.style.width = confidencePercent + '%';
            confidenceBar.textContent = confidencePercent + '%';

            const featureHTML = `
                <div class="feature-item">
                    <div class="feature-name">Latitude</div>
                    <div class="feature-value">${result.features.latitude}¬∞</div>
                </div>
                <div class="feature-item">
                    <div class="feature-name">Longitude</div>
                    <div class="feature-value">${result.features.longitude}¬∞</div>
                </div>
                <div class="feature-item">
                    <div class="feature-name">Altitude</div>
                    <div class="feature-value">${result.features.altitude} km</div>
                </div>
                <div class="feature-item">
                    <div class="feature-name">Total Velocity</div>
                    <div class="feature-value">${result.features.totalVelocity} km/s</div>
                </div>
                <div class="feature-item">
                    <div class="feature-name">Radial Distance</div>
                    <div class="feature-value">${result.features.radialDistance} km</div>
                </div>
            `;
            
            document.getElementById('featureValues').innerHTML = featureHTML;
            document.getElementById('batchResults').innerHTML = '';

            // STEP 6: Display explainability
            const explanations = explainPrediction(result.rawFeatures, result.prediction);
            displayExplainability(explanations);
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                window.predictionStartTime = performance.now();
                
                const csv = event.target.result;
                const lines = csv.split('\n').filter(line => line.trim());
                const results = [];

                const startIdx = lines[0].includes('lat') ? 1 : 0;

                for (let i = startIdx; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => parseFloat(v.trim()));
                    if (values.length >= 8 && !values.some(isNaN)) {
                        const data = {
                            latitude: values[0],
                            longitude: values[1],
                            x_eci: values[2],
                            y_eci: values[3],
                            z_eci: values[4],
                            vel_x: values[5],
                            vel_y: values[6],
                            vel_z: values[7]
                        };
                        const result = predictSatellite(data);
                        results.push({ ...data, ...result });
                        
                        // STEP 6: Log each batch prediction
                        logPrediction(data, result);
                    }
                }

                displayBatchResults(results);
            };
            reader.readAsText(file);
        });

        function displayBatchResults(results) {
            document.getElementById('loading').classList.remove('show');
            document.getElementById('resultPanel').classList.add('show');
            document.getElementById('satelliteName').textContent = `${results.length} Predictions`;
            document.getElementById('confidenceBar').style.width = '100%';
            document.getElementById('confidenceBar').textContent = 'Batch Complete';
            document.getElementById('featureValues').innerHTML = '';
            document.getElementById('explainabilitySection').style.display = 'none';

            const tableHTML = `
                <h3 style="color: #00d4ff; margin: 20px 0;">Batch Prediction Results</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Predicted Satellite</th>
                            <th>Confidence</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Altitude (km)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map((r, idx) => `
                            <tr>
                                <td>${idx + 1}</td>
                                <td><strong>${r.prediction}</strong></td>
                                <td>${(r.confidence * 100).toFixed(1)}%</td>
                                <td>${r.latitude.toFixed(4)}</td>
                                <td>${r.longitude.toFixed(4)}</td>
                                <td>${r.features.altitude}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('batchResults').innerHTML = tableHTML;
        }

        // ============================================================
        // STEP 6: History Management Functions
        // ============================================================
        function showHistory() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            
            if (predictionLog.length === 0) {
                content.innerHTML = '<p style="color: #88ccff; text-align: center; padding: 40px;">No predictions yet. Make some predictions to see them here!</p>';
            } else {
                const historyHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Timestamp</th>
                                <th>Prediction</th>
                                <th>Confidence</th>
                                <th>Processing Time</th>
                                <th>Altitude</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${predictionLog.map((log, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                                    <td><strong style="color: #00d4ff;">${log.output.prediction}</strong></td>
                                    <td>${(log.output.confidence * 100).toFixed(1)}%</td>
                                    <td>${log.processingTime}ms</td>
                                    <td>${log.output.features.altitude} km</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; padding: 20px; background: rgba(0, 212, 255, 0.1); border-radius: 10px;">
                        <h3 style="color: #00d4ff; margin-bottom: 15px;">üìä Session Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #88ccff;">Total Predictions</div>
                                <div style="font-size: 1.8em; color: #00d4ff; font-weight: bold;">${predictionLog.length}</div>
                            </div>
                            <div>
                                <div style="color: #88ccff;">ISS Classifications</div>
                                <div style="font-size: 1.8em; color: #00d4ff; font-weight: bold;">
                                    ${predictionLog.filter(p => p.output.prediction === 'ISS').length}
                                </div>
                            </div>
                            <div>
                                <div style="color: #88ccff;">Sentinel1A Classifications</div>
                                <div style="font-size: 1.8em; color: #00d4ff; font-weight: bold;">
                                    ${predictionLog.filter(p => p.output.prediction === 'Sentinel1A').length}
                                </div>
                            </div>
                            <div>
                                <div style="color: #88ccff;">Avg Confidence</div>
                                <div style="font-size: 1.8em; color: #00d4ff; font-weight: bold;">
                                    ${(predictionLog.reduce((sum, p) => sum + p.output.confidence, 0) / predictionLog.length * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                content.innerHTML = historyHTML;
            }
            
            modal.classList.add('show');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.remove('show');
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all prediction history?')) {
                predictionLog = [];
                updatePerformanceStats();
                closeHistory();
                alert('Prediction history cleared!');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                closeHistory();
            }
        }

        // Download history as CSV
        function downloadHistory() {
            if (predictionLog.length === 0) {
                alert('No predictions to download!');
                return;
            }

            const csvContent = [
                ['Timestamp', 'Prediction', 'Confidence', 'Latitude', 'Longitude', 'Altitude', 'Velocity', 'Processing Time'],
                ...predictionLog.map(log => [
                    log.timestamp,
                    log.output.prediction,
                    log.output.confidence.toFixed(4),
                    log.input.latitude,
                    log.input.longitude,
                    log.output.features.altitude,
                    log.output.features.totalVelocity,
                    log.processingTime + 'ms'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `satellite_predictions_${new Date().toISOString()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
